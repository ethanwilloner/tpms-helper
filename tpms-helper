#!/bin/bash
# TPMS Helper v1
# Bash shell script to guide testing of Toyota PMV-107J TPMS sensors using rtl_433
# Requires rtl_433, jq, mapfile (bash >4.0)
# for more information, see https://r-c-y.net

MINLEVEL="-0.5" # minimum signal strength level for detection. Increase this if no sensor is detcted
SENSOR_TYPE="110" # sensor type, default is 110 for Toyota's PMJ-107V. See rtl_433 docs for more options
RX_FREQ="315000000" # Receive frequency to listen for signals, in Hz. Default is 315 MHz for Toyota sensors

# define command to run rtl_433
RUNSDR="rtl_433 -M level -f $RX_FREQ -F json -T 60 -R $SENSOR_TYPE -Y minlevel=$MINLEVEL"

# checking for rtl_433 installation
rtl_433 -V > /dev/null 2>&1 || { echo "rtl_433 was not found, please install it." >&2; exit 1; }

WHEELS=("front left" "back left" "back right" "front right") # define the four wheel positions to check
for ((i = 0; i < ${#WHEELS[@]}; i++)); do
    echo -e "\e[32mPlease place sensor at ${WHEELS[$i]} wheel!\e[0m"
    # begin listening for PMV-107J sensors on 315 MHz
    echo -e "\e[32mRunning rtl_433...\e[0m"
    mapfile -t SIGNALS < <( output=$($RUNSDR) || { echo -e "\e[31mCould not connect to RTL-SDR!\e[0m" >&2; exit 1; }  && echo "$output" | grep "{*}")
    if [[ ${#SIGNALS[@]} -gt 1 ]]; then
        echo -e "\e[33mReceived signals from multiple sensors at ${WHEELS[$i]} wheel.\e[0m"
        for SIGNAL in "${SIGNALS[@]}"; do
            ID=$(echo "$SIGNAL" | jq ".id")
            RSSI=$(echo "$SIGNAL" | jq ".rssi")
            echo "Found sensor with ID $ID, signal strength is $RSSI"
        done
    elif [[ ${#SIGNALS[@]} == 1 ]]; then
        echo -e "\e[32mReceived signals from one sensor at ${WHEELS[$i]} wheel.\e[0m"
        ID=$(echo "${SIGNALS[0]}" | jq ".id")
        RSSI=$(echo "${SIGNALS[0]}" | jq ".rssi")
        echo "Found sensor with ID $ID, signal strength is $RSSI"
    elif [[ ${#SIGNALS[@]} == 0 ]]; then
        echo -e "\e[31mReceived no signals at ${WHEELS[$i]} wheel.\e[0m"
    fi
done
